# Vue3の画面更新の仕組み

<hr />

以前のフロントエンド開発勉強会でVue.jsの基礎知識を学び、Vueのコードが書けるようになった方も多いかと思います。<br />今回はVueの仕組みの中でも重要であり、かつ理解しづらい画面更新の機能について解説してみます。<br />Vueでは画面表示のことを**レンダリング**といいます。

### ＜テーマ＞

- [仮想DOM](#仮想dom)
- [リアクティビティー](#リアクティビティー)
- [ライフサイクル](#ライフサイクル)
- [状態管理](#状態管理)

この4つを軸に、Vueの画面更新がどのように行われているかを説明していきます。<br />それぞれの関連性を考えるとVueの仕組みについて理解しやすいと思います。


<hr />

## 仮想DOM

### DOMとは

仮想DOMについて理解するには、まずDOMというものが何かを知る必要があります。
- DOMとは、Document Object Modelの略であり、ウェブ上でのHTMLの表現方法。
- HTMLをJavaScriptを使って編集する技術の登場によりHTMLをオブジェクト（ノードと呼ぶ）ごとに扱うためにDOMが考案された。
- ノードは階層構造に構成されており、その階層構造のことをノードツリーと呼ぶ
  - 開発者ツールで見たノードツリー

  |![](../document/images/スクリーンショット%202023-11-24%20115739.png)|
  |:--:|
- DOMにはノードをJavaScriptで扱うためのAPIが用意されているため、DOMを使用することで画面をあらかじめ設定したJavaScriptで操作することが可能になる。

### 仮想DOMとは

- 仮想DOMとは、Reactで提唱され、Vueでも採用されているWEB画面表示の仕組み。
- 仮想DOM内のノードは仮想ノードと呼ばれ、実際のDOMと同じようにツリー構造になっている。
- 実際のDOMとは別に仮想のDOMをメモリー内に保持し、更新時に実際のDOMと同期させるという方法で画面の更新を実現している。

### Vueにおける仮想DOM

- Vueは仮想DOMを使用したレンダリングシステムを採用している。
- **レンダリングまでのステップ**
  - **コンパイル**
    - Vueファイルは仮想DOMツリーを返す`レンダー関数`にコンパイルされる。
  - **マウント**
    - ランタイムレンダラーがレンダー関数を呼び出し、返された仮想DOMツリーを走査して実際のDOMを作成する。
    - この一連のマウント処理はリアクティブに実行されており、依存関係を追跡できる。この機能によってデータ更新を検知して画面を更新するというリアクティビティーが実現する。
  - **パッチ**
    - データが更新されるなど、依存関係に変更が入ると、更新された内容で新しい仮想DOMが作成される。新しい仮想DOMと古い仮想DOMを比較して更新されている内容だけを実際のDOMに適用する。
  
  |![](../document/images/スクリーンショット%202023-11-24%20175800.png)|
  |:--:|

- **仮想DOMを使用した画面更新の流れ(パッチ)**

  |![](../document/images/スクリーンショット%202023-11-24%20181956.png)|
  |:--:|

<hr />

## リアクティビティー

### リアクティビティーの基礎

- CompositionAPIでは、`ref()`関数を使用することが推奨されている
- `ref()`は、引数を受け取り、それを`.value`プロパティを持つ ref オブジェクトにラップして返す
- 初期値を引数で渡さなかった場合は`undefined`を含む型になる

```ts
import { ref } from 'vue'

const count = ref<number>(0)

const countUndefined = ref<number>() // number | undefined

console.log(count) // { value: 0 }
console.log(count.value) // 0
```

- テンプレート内で使用する場合は、自動でアンラップされるため、`.value`は必要ない

```HTML
<div>{{ count }}</div>
```

- `ref()`を使用して宣言した変数に対して状態を変化させる関数を公開すれば、リアクティブな変数として活用できる
- 公開した関数は、テンプレートでイベントハンドラーとして使用できる

```ts
function increment() {
    // JavaScript 内では .value が必要
    count.value++
  }
```

```HTML
<!-- increment()がクリックイベントのイベントハンドラーとして登録できる -->
<button @click="increment"> 
  {{ count }}
</button>
```


<hr />

## ライフサイクル

### ライフサイクルダイアグラム

|![](../document/images/スクリーンショット%202023-11-24%20110300.png)|
|:--:|

### CompositionAPIの場合のライフサイクル

- **setUp**
  - setUp関数内の処理が実行される。
  - データや公開される関数が準備される

- **Mounted**
  - VueインスタンスがDOM要素にマウントされる
  - =>SFCを解釈してHTMLが作成される
  - マウントが完了した段階でユーザーに画面が表示される
  - 子コンポーネントは親コンポーネントより先にマウントが完了する

- **Update**
  - コンポーネント内のリアクティブなデータが更新される
  - データの更新によってマウントされているHTMLが更新されて表示画面が変わることを再レンダリングという

- これらのライフサイクルの各イベントの前後にライフサイクルフックと呼ばれるAPIが用意されており、その時点で行う処理を記述することができる。

<hr />

## 状態管理

<hr />

## まとめ

Vueと同じようなフロントエンドフレームワークにReactがありますが、ReactはVueとは少しレンダリングの仕組みが異なります。<br />